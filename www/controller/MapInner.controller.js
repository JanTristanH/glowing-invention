sap.ui.define(["hwb/frontendhwb/controller/BaseController","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Sorter"],function(t,e,o,s,n,i,r,a){"use strict";let l=false;return t.extend("hwb.frontendhwb.controller.MapInner",{itemCache:[],_aParkingSpaceCache:[],_aStampedCache:[],_aUnStampedCache:[],_oMap:{},onInit:function(){t.prototype.onInit.apply(this,arguments);this.getModel().setSizeLimit(1e3);this.initializeAppModelForMap();this._oMap=this.byId("map");if(!this._oMap){return}if(!this.getModel("local")){var e=new r;e.setData({UserLocationLat:0,UserLocationLng:0,centerPosition:"10.615779999999972;51.80054",TravelTimes:[{}]});this.getView().setModel(e,"local");this._oMap.setCenterPosition(e.getProperty("/centerPosition"))}this.getRouter().getRoute("MapWithPOI").attachPatternMatched(this.onMapWithPOIRouteMatched,this);this.getRouter().getRoute("Map").attachPatternMatched(this.onMapRouteMatched,this)},onCloseBottomSheet:function(){this.getRouter().navTo("Map")},attachGroupChange:function(){this.getModel("app").attachPropertyChange(t=>{if(t.getParameter("path")=="/aSelectedGroupIds"){this.applyGroupFilter()}})},applyGroupFilter:function(){let t=this.getModel("app").getProperty("/aSelectedGroupIds")||[];t=JSON.parse(JSON.stringify(t));let e=this.getModel("app").getProperty("/currentUser");t.push(e?.ID);let n=new o("groupFilterStampings",s.NE,t.join(","));const i=this.byId("idStampingSpots").getBinding("items");if(i){i.filter(t.length>1?n:null)}},onGeoMapZoomChanged:function(t){let e=t.getParameter("zoomLevel");this.getModel("app").setProperty("/zoomlevel",parseInt(e,10));sessionStorage.setItem("lastZoomLevel",e)},onPressOpenFiltersMenu:function(t){var o=t.getSource(),s=this.getView();if(!this._pPopover){this._pPopover=e.load({id:s.getId(),name:"hwb.frontendhwb.fragment.MapFilters",controller:this}).then(function(t){s.addDependent(t);return t})}this._pPopover.then(function(t){t.openBy(o)})},onShowAllPress:function(){this.getModel("app").setProperty("bShowLabels",true);this.getModel("app").setProperty("bShowParkingSpots",true);this.getModel("app").setProperty("/bShowStampedSpots",true);this.getModel("app").setProperty("/bShowUnStampedSpots",true)},onLocateMePress:function(t,e=true){if(navigator.geolocation){n.show(this.getText("locatingMe"));navigator.geolocation.getCurrentPosition(function(t){let o={lat:t.coords.latitude,lng:t.coords.longitude};if(o.lat==0&&o.lng==0){n.show(this.getText("errorLocateMe"));return}let s=this.getModel("local");s.setProperty("/UserLocationLat",o.lat);s.setProperty("/UserLocationLng",o.lng);this._oMap.setInitialPosition(`${o.lng};${o.lat};0`);if(e){s.setProperty("/centerPosition",`${o.lng};${o.lat}`);this._oMap.zoomToGeoPosition(o.lng,o.lat,this.nZoomLevelLabelThreshold)}}.bind(this),function(t){n.show(this.getText("errorLocateMe"))}.bind(this),{timeout:7500})}else{n.show(this.getText("errorLocatorNotSupported"))}},onFormatBoxType:function(t,e,o,s){const n=s&&e||!s&&o;if(!n){return"Hidden"}if(t.groupSize==t.totalGroupStampings){return"Success"}else if(t.totalGroupStampings==0){return"Error"}else{return"Warning"}},onFormatLabelText:function(t,e,o,s,n,i){const r=n==i||s&&o&&e>=16;return r?t:""},onFormatStampLabelText:function(t,e,o,s,n,i,r,a){const l=i&&s||!i&&n;const c=r==a;const p=c?13:16;t=this.onFormatSpotText(t);return l&&o&&e>=p?t:""},onFormatBooleanToSemanticType:function(t,e){return t&&e>=13?"Default":"Hidden"},onFormatParkingText:function(t,e){return t>=11?e:""},onFormatSpotScale:function(t,e){if(t==e){return"1.4;1.4;1"}return"1;1;1"},onSpotContextMenu:function(t){if(this.getRouter().getHashChanger().hash.includes("tour")){return}this.onButtonOpenExternalPress(t)},onSearchFieldSuggest:function(t){const e=t.getSource();const n=t.getParameter("suggestValue").toLowerCase();let i=[];if(n.includes("stempelstelle")){i.push(new o("name",s.Contains,n))}else{for(const t of n.split(" ")){i.push(new o("name",s.Contains,t));i.push(new o("name",s.Contains,t.charAt(0).toUpperCase()+t.slice(1)))}}const r=new o({filters:i,and:false});this.getModel().read("/AllPointsOfInterest",{filters:[r],sorters:[new a("orderBy")],urlParameters:{$top:10},success:function(t){this.getModel("local").setProperty("/suggestionItems",t.results);e.suggest()}.bind(this)})},onSearchFieldSearch:function(t){let e=t.getParameter("suggestionItem");const o=t.getSource();if(!e){e=o.getSuggestionItems()[0]}if(e){o._blur();this.getRouter().navTo("MapWithPOI",{idPOI:e.getKey()})}else{n.show(this.getText("selectPointFromList"))}},onMapRouteMatched:function(t){let e=sessionStorage.getItem("lastCenterPosition");if(e){this._oMap.setCenterPosition(e);this.onLocateMePress(null,false)}else{this.onLocateMePress(null,true)}this.applyGroupFilter();this.getModel("local").setProperty("/sCurrentSpotId","");this.byId("bottomSheet")?.setVisible(false)},onMapWithPOIRouteMatched:function(t){this.onLocateMePress(null,false);const e=()=>{const t=this.byId("bottomSheet");if(!t){setTimeout(e,50);return}t.setVisible(true);const o=()=>{const e=t.getDomRef();if(!e){setTimeout(o,50);return}e.style.display="block";e.style.bottom="-420px";this._initBottomSheetDrag()};o()};e();let o=t.getParameter("arguments").idPOI;this.getModel("local").setProperty("/sCurrentSpotId",o);const s=this._getPoiById(o);let n=this.getModel("local");n.setProperty("/sCurrentSpotId",o);n.setProperty("/title",s.name);n.setProperty("/description",s.description);n.setProperty("/bStampingVisible",!!s.number);n.setProperty("/bStampingEnabled",!s.hasVisited);n.setProperty("/sSelectedSpotLocation",`${s.longitude};${s.latitude}`);n.setProperty("/oCurrentSpot",this._getPoiById(o));this._loadRelevantTravelTimesForPoi(o,n);this._oMap.zoomToGeoPosition(s.longitude,s.latitude,this.nZoomLevelLabelThreshold)},onSpotClick:function(t){this.getRouter().navTo("MapWithPOI",{idPOI:t.getSource().getBindingContext().getProperty("ID")})},_loadRelevantTravelTimesForPoi:function(t,e){let o=[new sap.ui.model.Filter("fromPoi",sap.ui.model.FilterOperator.EQ,t),new sap.ui.model.Filter("travelMode",sap.ui.model.FilterOperator.EQ,"walk"),new sap.ui.model.Filter("distanceMeters",sap.ui.model.FilterOperator.LT,1e4)];let s=[new sap.ui.model.Sorter("distanceMeters",false)];this.getModel().read("/TravelTimes",{filters:o,sorters:s,urlParameters:{$top:5},success:function(t){let e=this.getModel("local");if(t&&t.results){e.setProperty("/TravelTimes",t.results)}else{e.setProperty("/TravelTimes",[])}let o=this.byId("idTravelTimesList");o?.removeAllItems();t.results.forEach(t=>{let e=new sap.m.StandardListItem({title:this._getPoiById(t.toPoi)?.name||"",description:`${this.formatMetersToKilometers(t.distanceMeters)} - ${this.formatSecondsToTime(t.durationSeconds)}`,icon:"sap-icon://task",type:"Navigation",press:this.onNearbyPress.bind(this)});e.addCustomData(new sap.ui.core.CustomData({key:"poiId",value:t.toPoi}));o?.addItem(e)})}.bind(this),error:function(t){console.error("Error loading travel times:",t)}})},onButtonOpenExternalPress:function(t){let e=this.getModel("local");let o=this._getPoiById(e.getProperty("/sCurrentSpotId"));const s=`https://www.harzer-wandernadel.de/?s=${o.name}`;window.open(s,"_blank").focus()},formatStampButtonIcon:function(t){if(t){return"sap-icon://checklist-item"}else{return"sap-icon://checklist-item-2"}},onDeleteStampPress:function(t){const e=this.getModel();let o=this.getModel("local").getProperty("/sCurrentSpotId");const s="/"+this.getModel().getProperty(`/Stampboxes(guid'${o}')/Stampings`)[0];i.confirm(this.getResourceBundle().getText("confirmDeletionOfX",this._getPoiById(o).name),{icon:i.Icon.WARNING,title:this.getText("confirmDeletionTitle"),actions:[i.Action.YES,i.Action.NO],emphasizedAction:i.Action.NO,onClose:o=>{if(o===i.Action.YES){let o={success:()=>{n.show(this.getText("deletedStamping"));this.applyGroupFilter();t.getSource().setVisible(false);this.getModel("local").setProperty("/bStampingEnabled",true)},error:()=>n.show("An Error Occurred")||oSelectedItem.setSelected(true)};e.remove(s,o)}else{oSelectedItem.setSelected(true)}}})},onButtonStampPress:function(t){const e=this.getModel(),o=this.getModel("local");let s=o.getProperty("/sCurrentSpotId");let i={success:()=>{t.getSource().setIcon("sap-icon://checklist-item-2");t.getSource().setEnabled(false);n.show(this.getText("savedStamping"));this.applyGroupFilter()},error:()=>n.show(this.getText("error"))};e.create("/Stampings",{stamp:{ID:s}},i)},onNavigateWithGoogleMaps:function(){const t=this.getModel("local").getProperty("/sSelectedSpotLocation");const e=t.split(";")[1];const o=t.split(";")[0];window.open(`https://maps.google.com/maps?daddr=${e},${o}&amp;ll=`)},onNavigateWithNative:function(){const t=this.getModel("local").getProperty("/sSelectedSpotLocation");const e=t.split(";")[1];const o=t.split(";")[0];const s=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;const n=s?`maps://maps.apple.com/?daddr=${e},${o}`:`geo:${e},${o}?q=${e},${o}`;window.open(n,"_self")},onNearbyPress:function(t){const e=t.getSource().data().poiId;this.getRouter().navTo("MapWithPOI",{idPOI:e})},onGeoMapCenterChanged:function(t){sessionStorage.setItem("lastCenterPosition",t.getParameter("centerPoint"))},onOpenGroupManagement:function(t){this.oMyAvatar=this.byId("idCurrentUserAvatarMapInner--idMyAvatar");this._oPopover.openBy(this.oMyAvatar??t.getSource())},_initBottomSheetDrag:function(){const t=()=>this.byId("bottomSheet").getDomRef();const e=t=>{const e="56";const o=-1*this.getModel("device").getProperty("/resize/height")*.8-(e-128);if(t<parseInt(o)){return o}else if(t>parseInt(e)){return e}else{return t}};const o=t();const s=o.querySelector(".sheet-header");const n=o.querySelector(".drag-handle");const i=o.querySelector(".sheet-content");s.addEventListener("mousedown",r.bind(this));n.addEventListener("mousedown",r.bind(this));i.addEventListener("mousedown",r.bind(this));document.addEventListener("mouseup",d.bind(this));document.addEventListener("mousemove",a.bind(this));s.addEventListener("touchstart",c.bind(this),{passive:false});n.addEventListener("touchstart",c.bind(this),{passive:false});i.addEventListener("touchstart",c.bind(this),{passive:false});document.addEventListener("touchend",d.bind(this));document.addEventListener("touchmove",p.bind(this),{passive:false});function r(e){l=true;this.startY=e.clientY;const o=t();this.startBottom=parseInt(getComputedStyle(o).bottom)}function a(o){if(!l)return;const s=o.clientY-this.startY;const n=t();n.style.bottom=e(this.startBottom-s)+"px"}function c(e){l=true;this.startY=e.touches[0].clientY;const o=t();this.startBottom=parseInt(getComputedStyle(o).bottom)}function p(o){if(!l)return;const s=o.touches[0].clientY-this.startY;const n=t();n.style.bottom=e(this.startBottom-s)+"px"}function d(){l=false}}})});
//# sourceMappingURL=MapInner.controller.js.map