sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/UIComponent","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(t,e,o,r,n,i,s){"use strict";return t.extend("hwb.frontendhwb.controller.BaseController",{nZoomLevelLabelThreshold:15,nZoomLevelClickThreshold:10,fallBackCords:"10.615779999999972;51.80054",onInit:function(){const t=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone;this.getModel("app").setProperty("/isInstallable",!t);this.oMyAvatar=this.getView().byId("idMyAvatar");this._oPopover=s.load({id:this.getView().getId(),name:"hwb.frontendhwb.fragment.userMenuPopover",controller:this}).then(function(t){this.getView().addDependent(t);this._oPopover=t}.bind(this))},onMyAvatarPress:function(t){var e=t?.getSource()??this.oMyAvatar;this.oMyAvatar=e;var o=this.oMyAvatar.getActive();this.oMyAvatar.setActive(!o);if(o){this._oPopover.close()}else{this._oPopover.openBy(e)}},onInstallPress:function(){installPWA()},onNavToInfoPress:function(){window.open("https://www.harzer-wander-buddy.de/impressum","_blank")},onPopoverClose:function(){this.oMyAvatar.setActive(false)},onUserMenuListItemPress:function(){this.oMyAvatar.setActive(false);this._oPopover.close()},onLogoutPress:function(){window.location.href="/logout"},onMyProfilePress:function(){this.getRouter().navTo("Profile",{userId:this.getModel("app").getProperty("/currentUser/ID")});this._oPopover.close()},onAvatarGroupPress:function(t){const e=t.getParameter("eventSource").getFieldGroupIds()[0];this.getRouter().navTo("Profile",{userId:e})},onOpenAdminPanelPress:function(){this.getRouter().navTo("Admin");this._oPopover.close()},initializeAppModelForMap:function(){let t=sessionStorage.getItem("lastZoomLevel")??this.nZoomLevelLabelThreshold;this.getModel("app").setProperty("/zoomlevel",parseInt(t));this.getModel("app").setProperty("/bShowLabels",true);this.getModel("app").setProperty("/bShowParkingSpots",true);this.getModel("app").setProperty("/bShowStampedSpots",true);this.getModel("app").setProperty("/bShowUnStampedSpots",true);this.attachGroupChange()},stringToBoolean:function(t){return t==="true"},onButtonSharePress:function(){navigator.share({title:document.title,text:"Harzer Wanderbuddy",url:window.location.href})},getRouter:function(){return o.getRouterFor(this)},getModel:function(t){return this.getView().getModel(t)??this.getOwnerComponent().getModel(t)},getText:function(t){return this.getOwnerComponent().getModel("i18n").getResourceBundle().getText(t)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},_getPoiById:function(t){let e=this.getModel();let o=e.getProperty(`/Stampboxes(guid'${t}')`);let r=e.getProperty(`/ParkingSpots(guid'${t}')`);return o||r},getStampByNumber:function(t){let e=Object.values(this.getModel().oData);return e.filter(e=>e.number==t).pop()},formatCleanMeter:function(t){if(isNaN(t)||t===null||t===undefined){return"0 m"}return`${parseInt(t)} m`},onNavBack:function(){var t,o;t=e.getInstance();o=t.getPreviousHash();if(o!==undefined){window.history.go(-1)}else{this.getRouter().navTo("appHome",{},true)}},onNavToMap:function(){this.getRouter().navTo("Map")},onNavToRouting:function(){this.getRouter().navTo("Routes")},onNavToList:function(t){this.getRouter().navTo("Main")},onNavToFriends:function(t){this.getRouter().navTo("FriendsList")},onButtonAdminMapPress:function(){this.getRouter().navTo("Admin")},onFormatRouteLineDash:function(t){if(t=="walk"){return"9;9"}return""},formatMetersToKilometers:function(t){if(!t&&t!==0){return""}var e=t/1e3;return e.toFixed(2)+" km"},formatSecondsToTime:function(t){if(!t&&t!==0){return""}var e=Math.floor(t/3600);var o=Math.floor(t%3600/60);var r=t%60;var n="";if(e>0){n+=e+" h "}if(o>0||e>0){n+=o+" min "}return n.trim()},_mapTravelTimeToPOIList:function(t){if(!Array.isArray(t)||!t.length){return[]}if(t.filter(t=>t.id=="start").length!=0){return t}let e=t[0].fromPoi;t.unshift({ID:"start",id:"start",name:this._getPoiById(e)?.name||this.getText("start"),toPoi:e,duration:0,distance:0,travelMode:"start",toPoiType:"start",rank:0});let o=2048;t.reverse();t=t.map(t=>{t.rank=o;o=o*2;return t});t.reverse();t=this._addStampedUsers(t);return t},_addStampedUsers:function(t){let e=this.getModel("app").getProperty("/aSelectedGroupIds")||[];e=JSON.parse(JSON.stringify(e));let o=this.getModel("app").getProperty("/currentUser");e.push(o.ID);t.forEach(t=>{const o=this._getPoiById(t.toPoi);if(o&&o.stampedUsers){t.stampedUsers=o.stampedUsers.filter(t=>e.includes(t.ID))}});return t},loadTourTravelTime:function(t,e){this.getModel().read(`/Tour2TravelTime`,{urlParameters:{$expand:"travelTime",$orderby:"rank asc"},filters:[new n("tour_ID",i.EQ,t)],success:function(t,o){const r=t.results.map(t=>{const e=t.travelTime;if(e){const t=this._getPoiById(e.toPoi);e.name=t?t.name:this.getText("start");e.duration=e.durationSeconds;e.distance=e.distanceMeters;if(e.elevationProfile){let t=e.elevationProfile.split(";");for(let e=0;e<t.length;e++){t[e]={x:e,y:parseFloat(t[e])}}e.elevationProfile=t}}return e}).filter(t=>!!t);e(r)}.bind(this),error:function(t){r.show("Error loading deferred entity!");console.error(t)}})},onFormatInitialsByName:function(t){if(!t){return t}if(t.length<=3){return t}return t.split(" ").map(t=>t.charAt(0).toUpperCase()).join("").substring(0,3)},isAdmin:function(t){if(!t)return false;if(Array.isArray(t)){return t.includes("admin")}return t.split(",").map(t=>t.trim()).includes("admin")},onStampGroupPress:function(){const t=this.getView().getModel("app");const e=this.getModel("local").getProperty("/bStampingEnabled");t.setProperty("/bStampingEnabled",e);t.setProperty("/bIncludeMe",e);if(!this._oStampDialog){s.load({id:this.getView().getId(),name:"hwb.frontendhwb.fragment.StampGroupDialog",controller:this}).then(t=>{this._oStampDialog=t;this.getView().addDependent(t);this._setupStampDialogBinding();t.open()})}else{this._setupStampDialogBinding();this._oStampDialog.open()}},_setupStampDialogBinding:function(){const t=this.byId("idGroupsMultiComboBoxStampGroupDialog");const e=t.getBinding("items");const o=this.getView().getModel("app");if(e){e.attachEventOnce("dataReceived",()=>{const t=e.getContexts();const r=t.map(t=>t.getObject()).filter(t=>t.isAllowedToStampForFriend).map(t=>t.ID);const n=o.getProperty("/aSelectedGroupIds")??[];const i=n.filter(t=>r.includes(t));o.setProperty("/aSelectedGroupIdsToStamp",i)});e.refresh(true)}else{console.warn("Items binding not yet available.")}},onConfirmStampGroup:function(){const t=this.getView().getModel("app");const e=t.getProperty("/bIncludeMe");const o=this.getModel("local").getProperty("/sCurrentSpotId");const n=t.getProperty("/aSelectedGroupIdsToStamp")||[];this.getModel().callFunction("/stampForGroup",{method:"POST",urlParameters:{sStampId:o,bStampForUser:!!e,sGroupUserIds:n},success:function(){this.getModel().refresh();this._oStampDialog.close()}.bind(this),error:function(t){r.show(this.getText("error"));this._oStampDialog.close()}.bind(this)})},onCancelStampGroup:function(){this._oStampDialog.close()},onFormatSpotText:function(t){if(!t)return"";const e=t.split(" / ");return e.pop()||""}})});
//# sourceMappingURL=BaseController.js.map