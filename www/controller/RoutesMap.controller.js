sap.ui.define(["hwb/frontendhwb/controller/MapInner.controller","sap/m/ColumnListItem","sap/m/MessageToast","sap/f/AvatarGroupItem","sap/ui/unified/Menu","sap/ui/unified/MenuItem","sap/ui/core/Popup"],function(t,e,o,i,r,s,n){"use strict";let a=false;return t.extend("hwb.frontendhwb.controller.RoutesMap",{bPersistedDisplayed:true,onInit:function(){t.prototype.onInit.apply(this,arguments);this.getModel("app").setProperty("/edit",false);this.getRouter().getRoute("RoutesDetailTransient").attachPatternMatched(this.onRoutesDetailTransientRouteMatched,this);this.getRouter().getRoute("RoutesDetail").attachPatternMatched(this.onRoutesDetailMatched,this);this.getRouter().getRoute("RoutesDetailEdit").attachPatternMatched(this.onRoutesDetailEditMatched,this);this.bus=this.getOwnerComponent().getEventBus();this.bus.subscribe("idRoutesWayPointList","onListSelect",this.onListSelect,this)},onAfterRendering:function(){this._initBottomSheetDrag();this._onElevationProfileUpdated()},onSearchFieldSearch:function(t){const e=this._getPoiById(t.getParameter("suggestionItem").getKey());this._getMap().zoomToGeoPosition(e.longitude,e.latitude,this.nZoomLevelLabelThreshold)},onSpotClick:function(t){if(this.getModel("app").getProperty("/edit")){var e=new r;const o=t.getSource().getBindingContext().getProperty("ID");e.addItem(new s({text:this.getModel("i18n").getProperty("addToEndOfTour"),select:function(t){this.onAddToEndOfTour(o)}.bind(this)}));e.open(false,t.getSource(),n.Dock.CenterCenter,n.Dock.CenterCenter)}},onSpotContextMenu:function(t){if(this.getModel("app").getProperty("/edit")){if(t.getParameter("menu")){var e=t.getParameter("menu");if(e.getItems().length==0){e.addItem(new s({text:this.getModel("i18n").getProperty("addToEndOfTour"),select:function(e){const o=t.getSource().getBindingContext().getProperty("ID")}.bind(this)}))}t.getSource().openContextMenu(e)}}},onAddToEndOfTour:function(t){const e=this.getModel("local").getProperty("/oSelectedTour/path");const o={rank:e[e.length-1]?.rank/2||1024,ID:Math.floor(Math.random()*1024)+1,toPoi:t,name:this._getPoiById(t).name};e.push(o);this.getModel("local").setProperty("/oSelectedTour/path",e);this._persistTourCopy(t)},_getMap(){return this.byId("midView--RoutesMapId--map")},onRoutesDetailMatched:function(){this.bPersistedDisplayed=true},onRoutesDetailEditMatched:function(){this.bPersistedDisplayed=true;this.getModel("app").setProperty("/edit",true)},onRoutesDetailTransientRouteMatched:function(t){this.bPersistedDisplayed=false;this.TourId=t.getParameter("arguments").TourId},onSplitterRoutesDetailResize:function(t){let e=t.getParameters().newSizes[1]-225;this.getModel("local").setProperty("/wayPointScrollContainerHeight",e+"px")},onBackToList:function(){this.getRouter().navTo("Routes")},onListSelect:function(t){},onFormatTravelModeIcon:function(t){if(t=="start"){return"sap-icon://functional-location"}else if(t=="drive"){return"sap-icon://car-rental"}return"sap-icon://physical-activity"},formatDescription:function(t,e){if(t===0&&e===0){return""}var o=this.formatSecondsToTime(t);var i=this.formatMetersToKilometers(e);return o+" - "+i},formatElevationDescription:function(t,e){return`↑ ${this.formatCleanMeter(t)} - ↓ ${this.formatCleanMeter(e)}`},onButtonShareTourPress:function(t){navigator.share({title:document.title,text:"Harzer Wanderbuddy",url:window.location.href})},onButtonEditPress:function(){var t=this.getModel();const e=this.getView().getModel("local");this.getModel("app").setProperty("/edit",true);let i=this.TourId||this.getRouter().getRouteInfoByHash(this.getRouter().getHashChanger().getHash()).arguments.TourId;if(this.bPersistedDisplayed&&i){this.getRouter().navTo("RoutesDetailEdit",{TourId:i})}else{var r={name:"Neue Tour",idListTravelTimes:e.getProperty("/sIdListTravelTimes"),duration:e.getProperty("/oSelectedTour/duration"),distance:e.getProperty("/oSelectedTour/distance"),stampCount:e.getProperty("/oSelectedTour/stampCount")||0};t.create("/Tours",r,{success:function(t,i){e.setProperty(`/Tours(${t.ID})`,t);o.show(this.getText("tourSaved"));this.getRouter().navTo("RoutesDetailEdit",{TourId:t.ID});location.reload()}.bind(this),error:function(t){o.show(this.getText("error"));console.error(t)}})}},onButtonSavePress:function(){const t=this.getView().getModel("local");this.getRouter().navTo("RoutesDetail",{TourId:t.getProperty("/sIdListTravelTimes")})},onDropSelectedProductsTable:function(t){let o={Initial:0,Default:1024,Before:function(t){return t+1024},Between:function(t,e){return(t+e)/2},After:function(t){return t/2}};var i=t.getParameter("draggedControl");var r=o;var s=r.Default;var n=t.getParameter("droppedControl");if(n instanceof e){var a=t.getParameter("dropPosition");var l=parseInt(n.getCells()[0].getText());var u=n.getParent();var d=u.indexOfItem(n);var c=d+(a==="After"?1:-1);var h=u.getItems()[c];if(!h){s=r[a](l)}else{let t=parseInt(h.getCells()[0].getText());s=r.Between(l,t)}}const g=this.getModel("local");let p=i.getCells()[1].getText();let f=g.getProperty("/oSelectedTour/path").map(t=>{if(t.ID==p){t.rank=s}return t});g.setProperty(`/oSelectedTour/path`,f);const m=this.byId("idEditRouteTable");const T=m.getBinding("items");const P=new sap.ui.model.Sorter({path:"rank",descending:true});T.sort(P);this._persistTour(m)},_persistTour:function(t){const e=this.getModel("local").getProperty("/oSelectedTour/name");let i=this.getModel("local").getProperty("/oSelectedTour/path").filter(t=>!!t.ID).sort((t,e)=>e.rank-t.rank);if(i.length>1){let t=[];t.push(i[0].fromPoi);i.forEach(e=>{t.push(e.toPoi)});i=i.map(t=>t.toPoi);const r=i.filter(t=>!!t).join(";");if(!r.includes(";")){return}const s=this.getModel("local").getProperty("/oSelectedTour/ID");this.getModel().callFunction("/updateTourByPOIList",{method:"POST",urlParameters:{POIList:r,TourID:s},success:function(t,i){o.show(this.getText("tourSaved"));const r=this.getModel("local");let n=t.updateTourByPOIList;n.name=e;r.setProperty("/oSelectedTour",n);this.loadTourTravelTime(s,function(t){r.setProperty(`/oSelectedTour/path`,this._mapTravelTimeToPOIList(t))}.bind(this))}.bind(this),error:function(t){o.show(this.getText("error"));console.error(t)}.bind(this)})}else{console.info("no calculation needed")}},onNameInputChange:function(t){let e=t.getSource().getValue();let i=this.getModel("local").getProperty("/oSelectedTour");let r="/Tours(guid'"+i.ID+"')";let s={name:e};this.getModel().update(r,s,{success:function(){this.getModel("local").getProperty("/oSelectedTour/name",e);o.show(this.getText("saved"))}.bind(this),error:function(t){o.show(this.getText("error"))}.bind(this)})},onButtonDeletePress:function(){const t=this.getModel("local").getProperty("/oSelectedTour").ID;this.getModel().remove(`/Tours(guid'${t}')`,{success:function(){o.show(this.getText("tourDeletedSuccessfully"));this.getRouter().navTo("Routes")}.bind(this),error:function(t){o.show(this.getText("error"));console.error(t)}.bind(this)})},onAddWayPointButtonPress:function(t){let e=this.getModel("local").getProperty("/oSelectedTour/path");let o=e[e.length-1]?.rank/2||1024;e.push({rank:o,ID:Math.floor(Math.random()*1024)+1});this.getModel("local").setProperty("/oSelectedTour/path",e)},onDeleteWayPointButtonPress:function(t){let e=this.getModel("local").getProperty("/oSelectedTour/path");const o=t.getSource();let i=o.getParent().getCells()[1].getText();e=e.filter(t=>t.ID!==i);this.getModel("local").setProperty("/oSelectedTour/path",e);this._persistTour(this.byId("idEditRouteTable"))},onSuggestionItemSelected:function(t){var e=t.getParameter("selectedItem");let o=this.getModel("local").getProperty("/oSelectedTour/path");var i=t.getSource().getParent().getCells()[1].getText();if(e){var r=e.getCustomData();r.forEach(function(t){if(t.getKey()==="ID"){var e=t.getValue();o=o.map(t=>{if(t.ID==i){t.toPoi=e}return t})}});this.getModel("local").setProperty("/oSelectedTour/path",o);this._persistTour(this.byId("idEditRouteTable"))}},onUpButtonPress:function(t){this._moveItem(t,-1)},onDownButtonPress:function(t){this._moveItem(t,1)},_moveItem:function(t,e){let o=t.getSource().getParent();o.rank=o.getCells()[0].getText();o.ID=o.getCells()[1].getText();const i=this.byId("idEditRouteTable");let r=i.getItems();let s=this._getSwitchingItem(r,o,e);if(!s){return}s.rank=s.getCells()[0].getText();s.ID=s.getCells()[1].getText();this._swapRanks(o,s);this._updateModel(o,s);this._refreshTable(i)},_getSwitchingItem:function(t,e,o){const i=t.findIndex(t=>t.rank==e.rank);const r=i+o;if(r>=0&&r<t.length){return t[r]}return null},_swapRanks:function(t,e){let o=t.rank;t.rank=e.rank;e.rank=o},_updateModel:function(t,e){const o=this.getModel("local");let i=o.getProperty("/oSelectedTour/path").map(o=>{if(o.ID===t.ID){o.rank=t.rank}if(o.ID===e.ID){o.rank=e.rank}return o});o.setProperty(`/oSelectedTour/path`,i)},_refreshTable:function(t){const e=t.getBinding("items");const o=new sap.ui.model.Sorter({path:"rank",descending:true});e.sort(o);this._persistTour(t)},onWaypointListSelectionChange:function(t){let e=t.getSource().getSelectedContextPaths()[0];let o=this.getModel("local").getProperty(e);let i=this._getPoiById(o.toPoi||o.fromPoi||o.poi);const r=this.getModel("device").getProperty("/resize/height");const s=r/1e3;const n=8e-4*s;this._getMap().zoomToGeoPosition(i.longitude,i.latitude-n)},formatStampButtonIcon:function(t){let e=this.getModel().getProperty(`/Stampboxes(guid'${t}')/hasVisited`);if(e){return"sap-icon://checklist-item-2"}else{return"sap-icon://checklist-item"}},formatStampButtonEnabled:function(t){return!this.getModel().getProperty(`/Stampboxes(guid'${t}')/hasVisited`)},formatStampButtonVisible:function(t){return!!this.getModel().getProperty(`/Stampboxes(guid'${t}')`)},onStampGroupPress:function(e){const o=e.getSource().getCustomData()[0].getValue();this.getModel("local").setProperty("/sCurrentSpotId",o);t.prototype.onStampGroupPress.apply(this,arguments)},onButtonStampPress:function(t){let e=this.getModel();let i=t.getSource().getCustomData()[0].getValue();let r={success:()=>{t.getSource().setIcon("sap-icon://checklist-item-2");t.getSource().setEnabled(false);o.show(this.getText("savedStamping"));e.refresh()},error:()=>o.show(this.getText("error"))};e.create("/Stampings",{stamp:{ID:i}},r)},onNavigateWithGoogleMaps:function(t){const e=this._getPoiById(t.getSource().getCustomData()[0].getValue());window.open(`https://maps.google.com/maps?daddr=${e.latitude},${e.longitude}&amp;ll=`)},onNavigateWithNative:function(t){const e=this._getPoiById(t.getSource().getCustomData()[0].getValue());const o=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;const i=o?`maps://maps.apple.com/?daddr=${e.latitude},${e.longitude}`:`geo:${e.latitude},${e.longitude}?q=${e.latitude},${e.longitude}`;window.open(i,"_self")},formatAvatarGroupItems:function(t){if(!t||!Array.isArray(t)){return[]}return t.map(t=>new i({initials:this.onFormatInitialsByName(t.name),fallbackIcon:"sap-icon://person-placeholder",src:t.picture||"",tooltip:t.name||"Unknown"}))},_persistTourCopy:function(t){const e=this.getModel("local").getProperty("/oSelectedTour/name");let i=this.getModel("local").getProperty("/oSelectedTour/path").filter(t=>!!t.ID).sort((t,e)=>e.rank-t.rank);if(i.length>0){let r=[];r.push(i[0].fromPoi);i.forEach(t=>{r.push(t.toPoi)});i=i.map(t=>t.toPoi);if(t){i.push(t)}const s=i.filter(t=>!!t).join(";");if(!s.includes(";")){return}const n=this.getModel("local").getProperty("/oSelectedTour/ID");this.getModel().callFunction("/updateTourByPOIList",{method:"POST",urlParameters:{POIList:s,TourID:n},success:function(t,i){o.show(this.getText("tourSaved"));const r=this.getModel("local");let s=t.updateTourByPOIList;s.name=e;r.setProperty("/oSelectedTour",s);this.loadTourTravelTime(n,function(t){r.setProperty(`/oSelectedTour/path`,this._mapTravelTimeToPOIList(t))}.bind(this))}.bind(this),error:function(t){o.show(this.getText("error"));console.error(t)}.bind(this)})}else{console.info("no calculation needed")}},_initBottomSheetDrag:function(){const t=()=>this.byId("bottomSheetTour")?.getDomRef();this.showBottomSheetWaitingForMap();const e=t=>{const e="56";const o=-1*this.getModel("device").getProperty("/resize/height")*.8-(e-128);if(t<parseInt(o)){return o}else if(t>parseInt(e)){return e}else{return t}};const o=t();const i=o.querySelector(".sheet-header");const r=o.querySelector(".drag-handle");const s=o.querySelector(".sheet-content");i.addEventListener("mousedown",n.bind(this));r.addEventListener("mousedown",n.bind(this));s.addEventListener("mousedown",n.bind(this));document.addEventListener("mouseup",c.bind(this));document.addEventListener("mousemove",l.bind(this));i.addEventListener("touchstart",u.bind(this),{passive:false});r.addEventListener("touchstart",u.bind(this),{passive:false});s.addEventListener("touchstart",u.bind(this),{passive:false});document.addEventListener("touchend",c.bind(this));document.addEventListener("touchmove",d.bind(this),{passive:false});function n(e){a=true;this.startY=e.clientY;const o=t();this.startBottom=parseInt(getComputedStyle(o).bottom)}function l(o){if(!a)return;const i=o.clientY-this.startY;const r=t();if(!r)return;r.style.bottom=e(this.startBottom-i)+"px"}function u(e){a=true;this.startY=e.touches[0].clientY;const o=t();if(!o)return;this.startBottom=parseInt(getComputedStyle(o).bottom)}function d(o){if(!a)return;const i=o.touches[0].clientY-this.startY;const r=t();if(!r)return;r.style.bottom=e(this.startBottom-i)+"px"}function c(){a=false}},showBottomSheetWaitingForMap:function(){const t=this._getMap();const e=this.byId("bottomSheetTour");if(!t||!e){setTimeout(()=>this.showBottomSheetWaitingForMap(),100);return}const o=t.getParent().getDomRef();if(!o||o.offsetWidth===0){setTimeout(()=>this.showBottomSheetWaitingForMap(),100);return}const i=e.getDomRef();i.style.display="block";i.style.bottom="-420px";i.style.width=o.offsetWidth+"px";i.style.right="0";i.style.left="auto";if(this._bottomSheetResizeObserver){this._bottomSheetResizeObserver.disconnect()}this._bottomSheetResizeObserver=new ResizeObserver(()=>{i.style.width=o.offsetWidth+"px";t.invalidateSize()});this._bottomSheetResizeObserver.observe(o)},_onElevationProfileUpdated:function(){const t=this.getView().getModel("local");const e=t.getProperty("/elevationProfile")||[];const o=document.getElementById("elevationChartCanvas");if(!o)return;if(this._elevationChart){this._elevationChart.destroy()}this._elevationChart=new Chart(o,{type:"line",data:{labels:e.map(t=>t.x),datasets:[{data:e.map(t=>t.y),fill:true,backgroundColor:"rgba(0, 123, 255, 0.2)",borderColor:"rgba(0, 123, 255, 1)",borderWidth:1,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false,min:t.getProperty("/minElevation")||0}}}})}})});
//# sourceMappingURL=RoutesMap.controller.js.map